<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Online Flipbook</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- StPageFlip -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip/dist/css/page-flip.css">
<script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>

<style>
/* base styles */
:root{
  --vh: 1vh;
  --controls-height: 110px;
  --controls-height-mobile: 92px;
  --toolbar-bottom: 16px;
  --page-max-width: 900px;
  --page-shadow: 0 12px 40px rgba(2,6,23,0.6);
}

/* full viewport using --vh (set by JS) */
html,body{height:100%;margin:0;padding:0;background:#0f172a;color:#fff;font-family:system-ui,-apple-system;}

/* center book and limit width for readability */
#book {
  width: 100%;
  height: calc(var(--vh,1vh)*100 - var(--controls-height));
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  padding: 18px;
}

/* mobile fallback (hidden when flipbook used) */
#mobileView {
  display:none;
  overflow-y:auto;
  padding:10px;
  padding-bottom: calc(var(--controls-height-mobile) + env(safe-area-inset-bottom));
}
#mobileView canvas{width:100%;margin-bottom:16px;border-radius:10px;box-shadow:var(--page-shadow);}

/* toolbar */
.toolbar{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:var(--toolbar-bottom);
  background:rgba(15,23,42,0.95);backdrop-filter:blur(8px);
  padding:10px 14px;border-radius:999px;display:flex;gap:8px;z-index:1200;
  box-shadow: 0 6px 22px rgba(2,6,23,0.5);
}
.toolbar button{border:none;background:linear-gradient(135deg,#38bdf8,#0ea5e9);color:#001; font-weight:600;
  padding:10px 12px;border-radius:999px;cursor:pointer;font-size:16px;min-width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;}
.toolbar button:active{transform:scale(.97);}

/* slider (quick nav) */
.sliderBar{
  position:fixed;left:0;right:0;bottom:calc(var(--toolbar-bottom) + 64px + env(safe-area-inset-bottom));
  display:flex;justify-content:center;pointer-events:none;z-index:1100;
}
.sliderBar .inner{pointer-events:auto;width:min(var(--page-max-width),95%);background:rgba(15,23,42,0.95);padding:8px;border-radius:999px;display:flex;gap:8px;align-items:center;}
.sliderBar input[type=range]{width:100%}
.pageLabel{min-width:56px;text-align:center;color:#fff;font-size:13px}

/* page container styling to avoid overlap */
.pf-page{
  position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;
  box-shadow:var(--page-shadow);border-radius:6px;background:#fff;
}

/* canvas fits inside page preserving aspect ratio */
.pf-page canvas{
  width:auto;height:100%;max-width:100%;max-height:100%;object-fit:contain;display:block;
  -webkit-backface-visibility:hidden;backface-visibility:hidden;
}

/* responsive tweaks */
@media (max-width:768px){
  #book{height:calc(var(--vh,1vh)*100 - var(--controls-height-mobile));padding:10px}
  .toolbar{bottom:10px;padding:8px 10px}
  .sliderBar{bottom:64px}
}

/* loader */
#loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,6,23,0.6),rgba(2,6,23,0.85));z-index:1300;color:#fff;font-size:14px}
#loader .box{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.02);padding:12px 16px;border-radius:12px}
</style>
</head>
<body>

<div id="book" aria-label="Flipbook viewer"></div>
<div id="mobileView" aria-hidden="true"></div>

<!-- loader -->
<div id="loader"><div class="box">กำลังโหลดหนังสือ… <span id="loaderCount"></span></div></div>

<!-- Slider -->
<div class="sliderBar" id="sliderBar" style="display:none">
  <div class="inner">
    <input id="pageSlider" type="range" min="1" max="1" value="1" aria-label="เลื่อนหน้า" />
    <div class="pageLabel" id="pageLabel">1/1</div>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar" role="toolbar" aria-label="Controls">
  <button id="prevBtn" title="ก่อนหน้า (←)" aria-label="ก่อนหน้า">◀</button>
  <button id="homeBtn" title="หน้าแรก (Home)" aria-label="หน้าแรก">⌂</button>
  <button id="nextBtn" title="ถัดไป (→)" aria-label="ถัดไป">▶</button>
  <button id="fsBtn" title="เต็มจอ (F)" aria-label="เต็มจอ">⛶</button>
</div>

<script>
/* lightweight utilities */
const $ = s => document.querySelector(s);
const setAttr = (el,o)=>Object.keys(o).forEach(k=>el.setAttribute(k,o[k]));
let pageFlip, isMobile = window.innerWidth <= 768, currentPage=1, totalPages=0;
const loader = $('#loader'), loaderCount = $('#loaderCount'), sliderBar = $('#sliderBar'), slider = $('#pageSlider'), pageLabel = $('#pageLabel');

/* set --vh for mobile browser chrome quirks */
function updateVh(){ document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
updateVh();

/* debounce */
function debounce(fn, wait=120){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }

/* PDF worker */
if(window.pdfjsLib && !pdfjsLib.GlobalWorkerOptions.workerSrc) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* compute responsive target size using first page aspect ratio */
function computeTargetSize(firstPageWidth, firstPageHeight){
  const baseW=600, baseH=850;
  const maxW = Math.min(document.documentElement.clientWidth * 0.95,  Math.max(baseW, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--page-max-width')) || 900));
  // preserve PDF aspect ratio
  const aspect = firstPageWidth / firstPageHeight || (baseW/baseH);
  let tw = Math.min(baseW, Math.floor(maxW));
  // if very wide screen allow larger but not exceeding maxW
  tw = Math.min(maxW, Math.max(320, tw));
  const th = Math.round(tw / aspect);
  return { width: tw, height: th };
}

/* update slider UI */
function updateSliderUI(){
  if(slider) slider.value = Math.min(Math.max(1, currentPage), totalPages||1);
  if(pageLabel) pageLabel.textContent = `${currentPage}/${totalPages||0}`;
}

/* try to read current page index from PageFlip safely */
function refreshCurrentPageFromFlip(){
  try{
    if(pageFlip && typeof pageFlip.getCurrentPageIndex === 'function'){
      const idx = pageFlip.getCurrentPageIndex(); // zero-based?
      // PageFlip's API may be zero-based; detect and convert
      if(typeof idx === 'number'){
        currentPage = ('pageNum' in pageFlip && pageFlip.pageNum)? pageFlip.pageNum : (idx + 1);
      }
    }
  }catch(e){}
  updateSliderUI();
}

/* show/hide loader */
function setLoader(show, text=''){
  loader.style.display = show ? 'flex' : 'none';
  loaderCount.textContent = text;
}

/* main: load PDF, compute sizes, render pages, init PageFlip */
pdfjsLib.getDocument("book.pdf").promise.then(async pdf=>{
  setLoader(true,'');

  // get first page to determine aspect ratio
  const first = await pdf.getPage(1);
  const vp = first.getViewport({scale:1});
  const {width:fw, height:fh} = vp;
  const {width:targetWidth, height:targetHeight} = computeTargetSize(fw, fh);

  // init PageFlip (works on mobile too)
  const bookEl = document.getElementById('book');
  pageFlip = new St.PageFlip(bookEl, {
    width: targetWidth,
    height: targetHeight,
    size: 'stretch',
    minWidth: 280,
    maxWidth: 4000,
    minHeight: 200,
    maxHeight: 4000,
    showCover: true,
    mobileScrollSupport: false
  });

  // render pages (DPR-aware) into same logical size canvases
  const DPR = Math.min(window.devicePixelRatio || 1, 1.5);
  const pagePromises = [];
  for(let i=1;i<=pdf.numPages;i++){
    pagePromises.push(
      pdf.getPage(i).then(page=>{
        const orig = page.getViewport({scale:1});
        const scale = Math.min(targetWidth / orig.width, targetHeight / orig.height);
        const rvp = page.getViewport({scale});
        const renderCanvas = document.createElement('canvas');
        renderCanvas.width = Math.ceil(rvp.width * DPR);
        renderCanvas.height = Math.ceil(rvp.height * DPR);
        const ctx = renderCanvas.getContext('2d');
        if(ctx){ ctx.imageSmoothingEnabled=true; try{ctx.imageSmoothingQuality='high'}catch(e){} }
        ctx.setTransform(DPR,0,0,DPR,0,0);
        return page.render({canvasContext:ctx, viewport:rvp}).promise.then(()=>{
          const final = document.createElement('canvas');
          final.width = Math.ceil(targetWidth * DPR);
          final.height = Math.ceil(targetHeight * DPR);
          const fctx = final.getContext('2d');
          if(fctx){ fctx.imageSmoothingEnabled=true; }
          // white background
          fctx.fillStyle='#ffffff';
          fctx.fillRect(0,0,final.width,final.height);
          // center rendered content
          const dw = renderCanvas.width, dh = renderCanvas.height;
          const ox = Math.round((final.width - dw)/2), oy = Math.round((final.height - dh)/2);
          fctx.drawImage(renderCanvas, ox, oy, dw, dh);
          final.style.width = targetWidth + 'px';
          final.style.height = targetHeight + 'px';
          final.style.display='block';
          return final;
        });
      })
    );
  }

  // update loader progress
  let loaded = 0;
  pagePromises.forEach(p => p.then(()=>{ loaded++; setLoader(true, `${loaded}/${pagePromises.length}`); }));

  const canvases = await Promise.all(pagePromises);
  setLoader(false);
  totalPages = canvases.length;

  // build page elements
  const pageElements = canvases.map(canvas=>{
    const el = document.createElement('div');
    el.className='pf-page';
    el.style.width = targetWidth + 'px';
    el.style.height = targetHeight + 'px';
    el.appendChild(canvas);
    return el;
  });

  pageFlip.loadFromHTML(pageElements);
  // small delay for layout
  setTimeout(()=>{ try{ pageFlip.update(); }catch(e){} }, 60);
  setTimeout(()=>{ try{ pageFlip.update(); }catch(e){} }, 300);

  // show slider
  sliderBar.style.display = 'flex';
  slider.max = totalPages;
  slider.value = 1;
  pageLabel.textContent = `1/${totalPages}`;

  // safe event hook for page changes
  try{
    if(typeof pageFlip.on === 'function'){
      pageFlip.on('flip', e=>{
        // e.data might contain page index; try to derive current page
        if(e && e.data != null){
          currentPage = (typeof e.data === 'number') ? (e.data + 1) : e.data;
        } else {
          refreshCurrentPageFromFlip();
        }
        updateSliderUI();
      });
    }
  }catch(e){/* ignore if API differs */ }

  // slider input => jump
  slider.addEventListener('input', e=>{
    const p = parseInt(e.target.value,10)||1;
    currentPage = p;
    updateSliderUI();
    try{ pageFlip.turnToPage(p); }catch(e){}
    try{ pageFlip.update(); }catch(e){}
  });

  // initial update
  updateSliderUI();
});

/* Controls (work on mobile & desktop) */
$('#nextBtn').addEventListener('click', ()=>{ try{ pageFlip.flipNext(); }catch(e){}; if(currentPage<totalPages) currentPage++; updateSliderUI(); try{ pageFlip.update(); }catch(e){}; });
$('#prevBtn').addEventListener('click', ()=>{ try{ pageFlip.flipPrev(); }catch(e){}; if(currentPage>1) currentPage--; updateSliderUI(); try{ pageFlip.update(); }catch(e){}; });
$('#homeBtn').addEventListener('click', ()=>{ try{ pageFlip.turnToPage(1); }catch(e){}; currentPage=1; updateSliderUI(); try{ pageFlip.update(); }catch(e){}; });

/* fullscreen toggle */
$('#fsBtn').addEventListener('click', ()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
  else document.exitFullscreen().catch(()=>{});
});

/* keyboard navigation */
window.addEventListener('keydown', e=>{
  if(e.key==='ArrowRight') $('#nextBtn').click();
  if(e.key==='ArrowLeft') $('#prevBtn').click();
  if(e.key==='Home') $('#homeBtn').click();
  if(e.key==='f' || e.key==='F') $('#fsBtn').click();
});

/* update on resize / fullscreen with debounce */
const doResize = debounce(()=>{
  updateVh();
  try{ if(pageFlip) pageFlip.update(); }catch(e){}
});
window.addEventListener('resize', doResize);
document.addEventListener('fullscreenchange', doResize);
document.addEventListener('webkitfullscreenchange', doResize);

/* accessibility: hide loader when not used */
setLoader(true,''); // kept until pages signal loaded; loader toggled in PDF promise
</script>
</body>
</html>
